<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTHM Lab Report Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.37.11/build/docxtemplater.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.1.15/dist/docx-preview.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification {
            animation: slideIn 0.3s ease-out forwards;
        }
        @media print {
            body * { visibility: hidden; }
            #pdf-render-container, #pdf-render-container * { visibility: visible; }
            #pdf-render-container { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; }
            header, main, #notification-area { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <div id="notification-area" class="fixed top-5 right-5 z-50 flex flex-col gap-3"></div>

    <div id="pdf-render-container" class="hidden bg-white shadow-lg mx-auto p-8"></div>

    <header class="bg-blue-900 text-white shadow-lg relative z-10">
        <div class="container mx-auto px-4 py-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="bg-white p-2 rounded-lg">
                    <i class="fa-solid fa-file-word text-blue-900 text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">Lab Report Generator</h1>
                    <p class="text-blue-200 text-sm">UTHM Automated Template Filler</p>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 relative z-10">
        
        <div id="library-error" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 shadow-md" role="alert">
            <p class="font-bold"><i class="fa-solid fa-triangle-exclamation mr-2"></i>Network Block Detected</p>
            <p class="text-sm mt-1">The scripts are still being blocked. Please allow internet access or download the JS files locally.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Step 1</span>
                        Upload Template
                    </h2>
                    
                    <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-blue-500 transition-colors text-center group">
                        <input type="file" id="templateInput" accept=".docx" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleFileSelect(event)">
                        <div class="space-y-3" id="dropZoneContent">
                            <i class="fa-solid fa-cloud-arrow-up text-4xl text-gray-400 group-hover:text-blue-500 transition-colors"></i>
                            <p class="text-sm text-gray-500">Drop your <strong>template.docx</strong> here<br>or click to browse</p>
                        </div>
                        <div id="fileSuccess" class="hidden space-y-3">
                            <i class="fa-solid fa-check-circle text-4xl text-green-500"></i>
                            <p class="text-sm text-gray-800 font-medium" id="fileName">template.docx</p>
                            <button class="text-xs text-red-500 hover:text-red-700 underline z-20 relative" onclick="resetFile(event)">Remove</button>
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 p-6 rounded-xl border border-blue-100">
                    <h3 class="font-semibold text-blue-900 mb-2">How it works</h3>
                    <ul class="text-sm text-blue-800 space-y-2 list-disc list-inside">
                        <li>Upload your UTHM Word template (must use tags like <code class="bg-blue-100 px-1">&lt;&lt;Student Name&gt;&gt;</code>).</li>
                        <li>Fill in the details form.</li>
                        <li>Select <strong>Word</strong> to download or <strong>PDF</strong> to print.</li>
                    </ul>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-full">
                    <h2 class="text-lg font-semibold text-gray-800 mb-6 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Step 2</span>
                        Enter Details
                    </h2>

                    <form id="reportForm" onsubmit="generateDoc(event)" class="space-y-6">
                        
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Output Format</label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="outputFormat" value="docx" checked class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                                    <span class="text-gray-700"><i class="fa-regular fa-file-word text-blue-600 mr-1"></i> Word (.docx)</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="outputFormat" value="pdf" class="w-4 h-4 text-red-600 focus:ring-red-500">
                                    <span class="text-gray-700"><i class="fa-regular fa-file-pdf text-red-600 mr-1"></i> PDF (Print View)</span>
                                </label>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <h3 class="text-sm uppercase tracking-wide text-gray-500 font-bold border-b pb-2">Subject Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Subject Name</label>
                                    <input type="text" name="Subject Name" placeholder="e.g. Operating Systems" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Subject Code</label>
                                    <input type="text" name="Code Subject" placeholder="e.g. BIT 20203" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                    <select name="Semester" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                                        <option value="1">Semester 1</option>
                                        <option value="2">Semester 2</option>
                                        <option value="3">Short Semester</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                                    <input type="text" name="Year" placeholder="e.g. 2024/2025" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <h3 class="text-sm uppercase tracking-wide text-gray-500 font-bold border-b pb-2 pt-2">Lab Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Lab Number</label>
                                    <input type="text" name="Lab Number" placeholder="e.g. 01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Section Number</label>
                                    <input type="text" name="Section Number" placeholder="e.g. 02" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Lecturer Name</label>
                                    <input type="text" name="Lecturer Name" placeholder="e.g. Dr. Ali Bin Abu" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <h3 class="text-sm uppercase tracking-wide text-gray-500 font-bold border-b pb-2 pt-2">Student Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Student Name</label>
                                    <input type="text" name="Student Name" placeholder="Your Full Name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Matric Number</label>
                                    <input type="text" name="Matric Number" placeholder="e.g. AI210005" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition" required>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 flex items-center justify-end">
                            <button type="submit" id="generateBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>
                                Generate Document
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        let uploadedTemplateArrayBuffer = null;

        // --- Library Check ---
        window.addEventListener('load', function() {
            if (typeof PizZip === 'undefined' || typeof docxtemplater === 'undefined') {
                document.getElementById('library-error').classList.remove('hidden');
                console.error("Libraries failed to load. Check network connection.");
            }
        });

        // --- Notification System ---
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-area');
            const toast = document.createElement('div');
            const bgClass = type === 'error' ? 'bg-red-500' : (type === 'info' ? 'bg-blue-500' : 'bg-green-500');
            const iconClass = type === 'error' ? 'fa-circle-exclamation' : (type === 'info' ? 'fa-circle-info' : 'fa-check-circle');

            toast.className = `notification ${bgClass} text-white px-6 py-4 rounded-lg shadow-xl flex items-center gap-3 min-w-[300px]`;
            toast.innerHTML = `
                <i class="fa-solid ${iconClass} text-xl"></i>
                <div class="flex-1">
                    <p class="font-medium">${message}</p>
                </div>
                <button onclick="this.parentElement.remove()" class="text-white/70 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    toast.style.transition = 'all 0.3s ease-in';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 4000);
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedTemplateArrayBuffer = e.target.result;
                document.getElementById('dropZoneContent').classList.add('hidden');
                document.getElementById('fileSuccess').classList.remove('hidden');
                document.getElementById('fileName').textContent = file.name;
                showNotification("Template uploaded successfully!");
            };
            reader.readAsArrayBuffer(file);
        }

        function resetFile(event) {
            event.preventDefault();
            document.getElementById('templateInput').value = '';
            uploadedTemplateArrayBuffer = null;
            document.getElementById('dropZoneContent').classList.remove('hidden');
            document.getElementById('fileSuccess').classList.add('hidden');
            showNotification("Template removed.", "info");
        }

        async function generateDoc(event) {
            event.preventDefault();

            // Double check library availability at runtime
            if (typeof PizZip === 'undefined') {
                showNotification("Critical Error: Library 'PizZip' did not load.", "error");
                return;
            }

            if (!uploadedTemplateArrayBuffer) {
                showNotification("Please upload a .docx template first!", "error");
                return;
            }

            try {
                // 1. Initialize PizZip
                const zip = new PizZip(uploadedTemplateArrayBuffer);

                // 2. Initialize Docxtemplater
                const doc = new docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                    delimiters: { start: '<<', end: '>>' }
                });

                // 3. Gather Data
                const formData = new FormData(event.target);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });
                data['Section Number'] = data['Section Number']; 

                // 4. Render
                doc.render(data);

                // 5. Generate Output
                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });

                const format = document.querySelector('input[name="outputFormat"]:checked').value;
                const filename = `Lab_Report_${data['Student Name'] || 'Generated'}`;

                if (format === 'docx') {
                    saveAs(out, `${filename}.docx`);
                    showNotification("Word document generated and downloaded!");
                } else {
                    showNotification("Preparing PDF preview...", "info");
                    await renderForPdf(out);
                }

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if (error.properties && error.properties.errors) {
                     msg = error.properties.errors.map(e => e.properties.explanation).join("\n");
                }
                showNotification("Error: " + msg, "error");
            }
        }

        async function renderForPdf(blob) {
            const container = document.getElementById('pdf-render-container');
            container.innerHTML = '';
            
            const options = {
                className: "docx_viewer", 
                inWrapper: false, 
                ignoreWidth: false, 
                ignoreHeight: false,
                breakPages: true
            };

            try {
                await docx.renderAsync(blob, container, null, options);
                showNotification("Opening print dialog. Select 'Save as PDF'.", "success");
                setTimeout(() => {
                    window.print();
                }, 1000);
            } catch (err) {
                console.error(err);
                showNotification("Failed to render PDF preview.", "error");
            }
        }
    </script>
</body>
</html>