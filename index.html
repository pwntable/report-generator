<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTHM Lab Report Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.4/dist/pizzip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.37.11/build/docxtemplater.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.1.15/dist/docx-preview.min.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* PDF Preview Modal Background */
        #pdf-preview-modal {
            background-color: rgba(0, 0, 0, 0.8);
        }

        /* --- V5 PRINT FIX: Ensure Document is Visible --- */
        @media print {
            /* 1. Hide the regular website body */
            body > *:not(#pdf-preview-modal) { 
                display: none !important; 
            }

            /* 2. Force the Modal Wrapper to be Visible and fill the page */
            #pdf-preview-modal { 
                display: block !important; 
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                background: white !important;
                z-index: 99999 !important;
                overflow: visible !important;
            }

            /* 3. Hide the Blue Header & Buttons inside the modal */
            #modal-header-bar {
                display: none !important;
            }

            /* 4. Force the content area to expand fully */
            #pdf-preview-modal .overflow-auto,
            #pdf-preview-modal .max-w-4xl {
                overflow: visible !important;
                max-width: none !important;
                width: 100% !important;
                height: auto !important;
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* 5. Ensure the document container is visible */
            #pdf-render-container {
                display: block !important;
                padding: 0 !important;
                margin: 0 !important;
                box-shadow: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <div id="notification-area" class="fixed top-5 right-5 z-50 flex flex-col gap-3"></div>

    <div id="pdf-preview-modal" class="hidden fixed inset-0 z-[60] flex flex-col items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
            
            <div id="modal-header-bar" class="bg-blue-900 text-white p-4 flex justify-between items-center shadow-md shrink-0">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-print mr-2"></i>Print Preview</h3>
                <div class="flex gap-3">
                    <button onclick="triggerPrint()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-file-pdf"></i> Save as PDF
                    </button>
                    <button onclick="closePreview()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-lg">
                        Close
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-auto bg-gray-200 p-8" id="preview-scroll-area">
                <div id="print-instruction" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 text-sm hidden">
                    <p class="font-bold">How to save as PDF:</p>
                    <p>1. Click the green button above.</p>
                    <p>2. In the Destination dropdown, select <strong>"Save as PDF"</strong>.</p>
                </div>
                
                <div id="pdf-render-container" class="bg-white shadow-lg mx-auto p-12 min-h-[1000px] text-gray-800"></div>
            </div>
        </div>
    </div>

    <header class="bg-blue-900 text-white shadow-lg relative z-10">
        <div class="container mx-auto px-4 py-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="bg-white p-2 rounded-lg">
                    <i class="fa-solid fa-file-word text-blue-900 text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">Lab Report Generator</h1>
                    <p class="text-blue-200 text-sm">UTHM Automated Template Filler</p>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 relative z-10">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Step 1</span>
                        Upload Template
                    </h2>
                    
                    <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-blue-500 transition-colors text-center group">
                        <input type="file" id="templateInput" accept=".docx" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="handleFileSelect(event)">
                        <div class="space-y-3" id="dropZoneContent">
                            <i class="fa-solid fa-cloud-arrow-up text-4xl text-gray-400 group-hover:text-blue-500 transition-colors"></i>
                            <p class="text-sm text-gray-500">Drop <strong>template.docx</strong> here</p>
                        </div>
                        <div id="fileSuccess" class="hidden space-y-3">
                            <i class="fa-solid fa-check-circle text-4xl text-green-500"></i>
                            <p class="text-sm text-gray-800 font-medium" id="fileName">file.docx</p>
                            <button class="text-xs text-red-500 hover:text-red-700 underline z-20 relative" onclick="resetFile(event)">Remove</button>
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 p-6 rounded-xl border border-blue-100 text-sm text-blue-800">
                    <h3 class="font-bold mb-2">Tips:</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Make sure your Word tags use double brackets: <code class="bg-blue-100 px-1">&lt;&lt;Tag&gt;&gt;</code></li>
                        <li><strong>For PDF:</strong> Use the preview window to check alignment, then click "Save as PDF".</li>
                    </ul>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-full">
                    <h2 class="text-lg font-semibold text-gray-800 mb-6 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Step 2</span>
                        Enter Details
                    </h2>

                    <form id="reportForm" onsubmit="generateDoc(event)" class="space-y-6">
                        
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Output Format</label>
                            <div class="flex gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="outputFormat" value="docx" checked class="w-4 h-4 text-blue-600">
                                    <span>Word (.docx)</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="outputFormat" value="pdf" class="w-4 h-4 text-red-600">
                                    <span>PDF (Preview & Print)</span>
                                </label>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <h3 class="text-sm uppercase tracking-wide text-gray-500 font-bold border-b pb-2">Subject Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Subject Name</label>
                                    <input type="text" name="Subject Name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Subject Code</label>
                                    <input type="text" name="Code Subject" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                    <select name="Semester" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                                        <option value="Semester 1">Semester 1</option>
                                        <option value="Semester 2">Semester 2</option>
                                        <option value="Short Semester">Short Semester</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                                    <input type="text" name="Year" placeholder="2025/2026" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <h3 class="text-sm uppercase tracking-wide text-gray-500 font-bold border-b pb-2 pt-2">Lab Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Lab Number</label>
                                    <input type="text" name="Lab Number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Section Number</label>
                                    <input type="text" name="Section Number" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Lecturer Name</label>
                                    <input type="text" name="Lecturer Name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <h3 class="text-sm uppercase tracking-wide text-gray-500 font-bold border-b pb-2 pt-2">Student Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Student Name</label>
                                    <input type="text" name="Student Name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Matric Number</label>
                                    <input type="text" name="Matric Number" placeholder="AI210005" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 flex items-center justify-end">
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg flex items-center gap-2 transition hover:-translate-y-0.5">
                                <i class="fa-solid fa-wand-magic-sparkles"></i> Generate Document
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        let uploadedTemplateArrayBuffer = null;

        // Notification Helper
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-area');
            const toast = document.createElement('div');
            const bgClass = type === 'error' ? 'bg-red-500' : (type === 'info' ? 'bg-blue-500' : 'bg-green-500');
            const iconClass = type === 'error' ? 'fa-circle-exclamation' : (type === 'info' ? 'fa-circle-info' : 'fa-check-circle');

            toast.className = `notification ${bgClass} text-white px-6 py-4 rounded-lg shadow-xl flex items-center gap-3 min-w-[300px] transition-all duration-300`;
            toast.innerHTML = `<i class="fa-solid ${iconClass} text-xl"></i><div class="flex-1"><p class="font-medium">${message}</p></div>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        // File Handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedTemplateArrayBuffer = e.target.result;
                document.getElementById('dropZoneContent').classList.add('hidden');
                document.getElementById('fileSuccess').classList.remove('hidden');
                document.getElementById('fileName').textContent = file.name;
                showNotification("Template ready!");
            };
            reader.readAsArrayBuffer(file);
        }

        function resetFile(event) {
            event.preventDefault();
            document.getElementById('templateInput').value = '';
            uploadedTemplateArrayBuffer = null;
            document.getElementById('dropZoneContent').classList.remove('hidden');
            document.getElementById('fileSuccess').classList.add('hidden');
        }

        // Generator Logic
        async function generateDoc(event) {
            event.preventDefault();
            if (!uploadedTemplateArrayBuffer) return showNotification("Please upload a template first!", "error");

            try {
                const zip = new PizZip(uploadedTemplateArrayBuffer);
                const doc = new docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                    // Safety: Returns empty string if tag is missing in Word doc
                    nullGetter: () => { return ""; }
                });

                const formData = new FormData(event.target);
                const data = {};
                formData.forEach((value, key) => data[key] = value);

                doc.render(data);

                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });

                const format = document.querySelector('input[name="outputFormat"]:checked').value;
                const filename = `Report_${data['Student Name'] || 'Generated'}`;

                if (format === 'docx') {
                    saveAs(out, `${filename}.docx`);
                    showNotification("Word document downloaded!");
                } else {
                    renderPdfPreview(out);
                }

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if (error.properties && error.properties.errors) {
                    msg = error.properties.errors.map(e => e.properties.explanation).join("\n");
                }
                showNotification("Error: " + msg, "error");
            }
        }

        // PDF Preview Logic
        async function renderPdfPreview(blob) {
            const modal = document.getElementById('pdf-preview-modal');
            const container = document.getElementById('pdf-render-container');
            const instruction = document.getElementById('print-instruction');
            
            container.innerHTML = '<div class="text-center py-10"><i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500"></i><p class="mt-4">Generating Preview...</p></div>';
            modal.classList.remove('hidden');

            try {
                // Using docx-preview
                const options = { 
                    className: "docx_viewer", 
                    inWrapper: false, 
                    ignoreWidth: false, 
                    ignoreHeight: false, 
                    breakPages: true 
                };
                await docx.renderAsync(blob, container, null, options);
                
                // Show instruction box after render
                instruction.classList.remove('hidden');
                showNotification("Preview generated. Click 'Save as PDF' to finish.");
            } catch (err) {
                console.error(err);
                container.innerHTML = '<p class="text-red-500 text-center">Failed to render preview.</p>';
                showNotification("Preview failed.", "error");
            }
        }

        function triggerPrint() {
            window.print();
        }

        function closePreview() {
            document.getElementById('pdf-preview-modal').classList.add('hidden');
        }
    </script>
</body>
</html>
